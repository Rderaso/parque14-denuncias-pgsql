<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parque 14 Denuncias - PostgreSQL</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
        }

        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }

        .badge-correlativo {
            font-size: 1.1rem;
            padding: 8px 15px;
        }

        #status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
    </style>
</head>
<body>

    <!-- Status Badge -->
    <div id="status" class="badge bg-info">
        <i class="fas fa-database"></i> Conectando...
    </div>

    <div class="container">
        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="text-white mb-3">
                <i class="fas fa-building"></i> Parque 14 - Sistema de Denuncias
            </h1>
            <p class="text-white">
                <i class="fas fa-server"></i> PostgreSQL Backend
            </p>
        </div>

        <!-- Formulario -->
        <div class="card mb-4">
            <div class="card-body">
                <h3 class="card-title mb-4">
                    <i class="fas fa-plus-circle"></i> Nueva Denuncia
                </h3>

                <form id="formDenuncia">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Lugar</label>
                            <input type="text" class="form-control" id="lugar" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tipo</label>
                            <select class="form-select" id="tipo" required>
                                <option value="">Seleccionar...</option>
                                <option value="Ascensores">Ascensores</option>
                                <option value="Parqueo">Parqueo</option>
                                <option value="Seguridad">Seguridad</option>
                                <option value="Mascotas">Mascotas</option>
                                <option value="Rentas cortas">Rentas cortas</option>
                                <option value="Piscina">Piscina</option>
                                <option value="Eléctricos">Eléctricos</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" id="descripcion" rows="4" required></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">A quién se reportó</label>
                            <input type="text" class="form-control" id="a_quien_se_reporto" value="Andreina Benítez" required>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tu nombre</label>
                            <input type="text" class="form-control" id="tu_nombre" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Comisión</label>
                        <select class="form-select" id="comision" required>
                            <option value="">Seleccionar...</option>
                            <option value="Comisión de Seguridad">Comisión de Seguridad</option>
                            <option value="Comisión de Convivencia">Comisión de Convivencia</option>
                            <option value="Comisión de Administración">Comisión de Administración</option>
                            <option value="Comisión de Infraestructura">Comisión de Infraestructura</option>
                            <option value="Comisión de Rentas Cortas">Comisión de Rentas Cortas</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        <i class="fas fa-paper-plane"></i> Enviar Denuncia
                    </button>
                </form>
            </div>
        </div>

        <!-- Historial -->
        <div class="card">
            <div class="card-body">
                <h3 class="card-title mb-4">
                    <i class="fas fa-history"></i> Historial de Denuncias
                    <span id="totalDenuncias" class="badge bg-primary">0</span>
                </h3>

                <div id="historial" class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Correlativo</th>
                                <th>Fecha</th>
                                <th>Lugar</th>
                                <th>Tipo</th>
                                <th>Descripción</th>
                                <th>Reportante</th>
                            </tr>
                        </thead>
                        <tbody id="tablaHistorial">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/api-backend.js"></script>
    <script>
        let denuncias = [];

        // Cargar denuncias al iniciar
        async function cargarDenuncias() {
            try {
                document.getElementById('status').className = 'badge bg-warning';
                document.getElementById('status').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';

                denuncias = await window.backendAPI.cargarDenuncias();
                mostrarHistorial();

                document.getElementById('status').className = 'badge bg-success';
                document.getElementById('status').innerHTML = `<i class="fas fa-check-circle"></i> ${denuncias.length} denuncias`;
            } catch (error) {
                document.getElementById('status').className = 'badge bg-danger';
                document.getElementById('status').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                alert('Error cargando denuncias: ' + error.message);
            }
        }

        // Mostrar historial
        function mostrarHistorial() {
            const tbody = document.getElementById('tablaHistorial');
            const total = document.getElementById('totalDenuncias');

            total.textContent = denuncias.length;

            if (denuncias.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay denuncias</td></tr>';
                return;
            }

            // Ordenar por correlativo descendente
            const denunciasOrdenadas = [...denuncias].sort((a, b) => b.correlativo - a.correlativo);

            tbody.innerHTML = denunciasOrdenadas.map(d => {
                const fecha = new Date(d.fecha_creacion);
                const fechaFormateada = fecha.toLocaleDateString('es-GT');
                const descripcionCorta = d.descripcion.substring(0, 80) + (d.descripcion.length > 80 ? '...' : '');

                return `
                    <tr>
                        <td><span class="badge badge-correlativo bg-primary">#${d.correlativo}</span></td>
                        <td>${fechaFormateada}</td>
                        <td>${d.lugar}</td>
                        <td><span class="badge bg-info">${d.tipo}</span></td>
                        <td>${descripcionCorta}</td>
                        <td>${d.tu_nombre}</td>
                    </tr>
                `;
            }).join('');
        }

        // Enviar denuncia
        document.getElementById('formDenuncia').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalHTML = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

            try {
                const denunciaData = {
                    lugar: document.getElementById('lugar').value,
                    tipo: document.getElementById('tipo').value,
                    descripcion: document.getElementById('descripcion').value,
                    a_quien_se_reporto: document.getElementById('a_quien_se_reporto').value,
                    tu_nombre: document.getElementById('tu_nombre').value,
                    comision: document.getElementById('comision').value
                };

                const resultado = await window.backendAPI.crearDenuncia(denunciaData);

                alert(`✅ Denuncia #${resultado.correlativo} creada exitosamente`);

                // Limpiar formulario
                e.target.reset();

                // Recargar denuncias
                await cargarDenuncias();

            } catch (error) {
                alert('❌ Error creando denuncia: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalHTML;
            }
        });

        // Cargar denuncias al iniciar
        cargarDenuncias();
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
